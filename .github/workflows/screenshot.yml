name: Take Screenshot

on:
  # Trigger this workflow only after the Pages deployment finishes
  workflow_run:
    workflows: ["pages-build-deployment"] # The default name of the GitHub Pages workflow
    types:
      - completed
  
  # Keep manual trigger for testing
  workflow_dispatch:

permissions:
  contents: write

jobs:
  screenshot:
    # Only run if deployment succeeded AND it wasn't triggered by the screenshot bot (prevents loops)
    if: ${{ github.event.workflow_run.conclusion == 'success' && !contains(github.event.workflow_run.head_commit.message, 'Auto-update homepage screenshot') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Take Screenshot
        uses: actions/github-script@v6
        with:
          script: |
            const puppeteer = require('puppeteer');
            
            const browser = await puppeteer.launch({
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            
            const page = await browser.newPage();
            
            // Set screen size
            await page.setViewport({ width: 1280, height: 800 });
            
            // Go to your website
            // Added a small hard wait to ensure CDN has propagated if necessary
            await page.goto('https://milankacar.github.io', { waitUntil: 'networkidle0' });
            
            // Ensure folder exists
            const fs = require('fs');
            if (!fs.existsSync('images')){
                fs.mkdirSync('images');
            }

            // Save screenshot
            await page.screenshot({ path: 'images/homepage-preview.png', fullPage: false });
            
            await browser.close();

      - name: Commit and Push Screenshot
        run: |
          git config --global user.name "MilanKacar"
          git config --global user.email "milankacar@live.com"
          
          # Check if there are changes to commit
          git add images/homepage-preview.png
          
          # If no changes, exit without error
          if git diff-index --quiet HEAD; then
            echo "No changes in screenshot to commit"
          else
            # Note: [skip ci] is good practice, but the 'if' check at the top is the real protection
            git commit -m "Auto-update homepage screenshot [skip ci]"
            git push
          fi
